{% extends "base.html" %}

{% block title %}Notes - LOOM{% endblock %}

{% block extra_css %}
<style>
    .markdown-preview {
        background-color: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 1rem;
        min-height: 200px;
        max-height: 400px;
        overflow-y: auto;
        color: var(--text-color);
    }

    .markdown-preview h1, .markdown-preview h2, .markdown-preview h3,
    .markdown-preview h4, .markdown-preview h5, .markdown-preview h6 {
        color: var(--text-color);
        margin-top: 1rem;
        margin-bottom: 0.5rem;
    }

    .markdown-preview h1 { font-size: 2rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.3rem; }
    .markdown-preview h2 { font-size: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3rem; }
    .markdown-preview h3 { font-size: 1.25rem; }

    .markdown-preview code {
        background-color: var(--card-background);
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.9rem;
    }

    .markdown-preview pre {
        background-color: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 1rem;
        overflow-x: auto;
    }

    .markdown-preview pre code {
        background: none;
        padding: 0;
    }

    .markdown-preview blockquote {
        border-left: 4px solid var(--primary-color);
        margin: 1rem 0;
        padding-left: 1rem;
        color: var(--text-muted);
    }

    .markdown-preview a {
        color: var(--primary-color);
        text-decoration: none;
    }

    .markdown-preview a:hover {
        text-decoration: underline;
    }

    .markdown-preview ul, .markdown-preview ol {
        padding-left: 2rem;
        margin: 0.5rem 0;
    }

    .markdown-preview hr {
        border: none;
        border-top: 1px solid var(--border-color);
        margin: 1rem 0;
    }

    .markdown-preview table {
        border-collapse: collapse;
        width: 100%;
        margin: 1rem 0;
    }

    .markdown-preview th, .markdown-preview td {
        border: 1px solid var(--border-color);
        padding: 0.5rem;
        text-align: left;
    }

    .markdown-preview th {
        background-color: var(--card-background);
    }

    .markdown-preview input[type="checkbox"] {
        margin-right: 0.5rem;
    }

    /* View modal specific styling - make the note BE the modal */
    #noteViewModal .modal-content {
        max-width: 900px;
        background-color: var(--background-color);
    }

    #noteViewModal .modal-body {
        padding: 2rem;
    }

    #noteViewModal #viewNoteContent {
        background: none;
        border: none;
        padding: 0;
        max-height: none;
        color: var(--text-color);
    }

    #noteViewModal #viewNoteContent h1,
    #noteViewModal #viewNoteContent h2,
    #noteViewModal #viewNoteContent h3,
    #noteViewModal #viewNoteContent h4,
    #noteViewModal #viewNoteContent h5,
    #noteViewModal #viewNoteContent h6 {
        color: var(--text-color);
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }

    #noteViewModal #viewNoteContent h1 { font-size: 2rem; }
    #noteViewModal #viewNoteContent h2 { font-size: 1.5rem; }
    #noteViewModal #viewNoteContent h3 { font-size: 1.25rem; }

    #noteViewModal #viewNoteContent p {
        margin: 1rem 0;
        line-height: 1.7;
    }

    #noteViewModal #viewNoteContent code {
        background-color: var(--card-background);
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.9rem;
    }

    #noteViewModal #viewNoteContent pre {
        background-color: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 1rem;
        overflow-x: auto;
        margin: 1rem 0;
    }

    #noteViewModal #viewNoteContent pre code {
        background: none;
        padding: 0;
    }

    #noteViewModal #viewNoteContent blockquote {
        border-left: 4px solid var(--primary-color);
        margin: 1rem 0;
        padding-left: 1rem;
        color: var(--text-muted);
    }

    #noteViewModal #viewNoteContent ul,
    #noteViewModal #viewNoteContent ol {
        padding-left: 2rem;
        margin: 1rem 0;
    }

    #noteViewModal #viewNoteContent a {
        color: var(--primary-color);
        text-decoration: none;
    }

    #noteViewModal #viewNoteContent a:hover {
        text-decoration: underline;
    }

    #noteViewModal #viewNoteContent hr {
        border: none;
        border-top: 1px solid var(--border-color);
        margin: 1.5rem 0;
    }

    #noteViewModal #viewNoteTitle {
        font-size: 2rem;
        margin: 0;
    }

    /* Note card content preview with markdown */
    .note-card .note-content {
        max-height: 150px;
        overflow: hidden;
        position: relative;
        color: var(--text-muted);
    }

    .note-card .note-content p {
        margin: 0.5rem 0;
    }

    .note-card .note-content h1,
    .note-card .note-content h2,
    .note-card .note-content h3 {
        font-size: 1rem;
        margin: 0.5rem 0;
        color: var(--text-color);
    }

    .note-card .note-content code {
        background-color: var(--background-color);
        padding: 0.1rem 0.3rem;
        border-radius: 3px;
        font-size: 0.85rem;
    }

    .note-card .note-content ul,
    .note-card .note-content ol {
        margin: 0.25rem 0;
        padding-left: 1.5rem;
    }

    .note-card .note-content strong {
        color: var(--text-color);
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="notes">
    <div class="page-header">
        <h2>Notes</h2>
        <button id="new-note-btn" class="btn btn-primary">New Note</button>
    </div>

    <div class="notes-container">
        <div id="notes-list"></div>
    </div>
</div>

<!-- Note View Modal -->
<div class="modal" id="noteViewModal">
    <div class="modal-content">
        <div class="modal-header">
            <div>
                <h3 id="viewNoteTitle"></h3>
                <div id="viewNoteCategory" style="margin-top: 0.5rem;"></div>
            </div>
            <button class="modal-close" id="closeViewModal">&times;</button>
        </div>
        <div class="modal-body">
            <div id="viewNoteContent"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" id="deleteNoteBtn">Delete</button>
            <button class="btn btn-primary" id="editNoteBtn">Edit</button>
        </div>
    </div>
</div>

<!-- Note Editor Modal -->
<div class="modal" id="noteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">New Note</h3>
            <button class="modal-close" id="closeModal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="noteTitle">Title</label>
                <input type="text" id="noteTitle" class="form-input" placeholder="Note title...">
            </div>

            <div class="form-group">
                <label for="noteCategory">Category (optional)</label>
                <input type="text" id="noteCategory" class="form-input" placeholder="e.g., Work, Personal, Ideas">
            </div>

            <div class="form-group">
                <label>Content (Markdown supported)</label>
                <!-- Markdown Toolbar -->
                <div class="markdown-toolbar">
                    <button type="button" class="md-btn" data-action="header" title="Header">H</button>
                    <button type="button" class="md-btn" data-action="bold" title="Bold"><strong>B</strong></button>
                    <button type="button" class="md-btn" data-action="italic" title="Italic"><em>I</em></button>
                    <button type="button" class="md-btn" data-action="strikethrough" title="Strikethrough"><s>S</s></button>
                    <button type="button" class="md-btn" data-action="code" title="Inline Code">&lt;/&gt;</button>
                    <button type="button" class="md-btn" data-action="codeblock" title="Code Block">{ }</button>
                    <button type="button" class="md-btn" data-action="link" title="Link">üîó</button>
                    <button type="button" class="md-btn" data-action="list" title="Bullet List">‚Ä¢‚Ä¢‚Ä¢</button>
                    <button type="button" class="md-btn" data-action="numberedlist" title="Numbered List">1.2.3</button>
                    <button type="button" class="md-btn" data-action="quote" title="Quote">‚ùù‚ùû</button>
                    <button type="button" class="md-btn" data-action="hr" title="Horizontal Rule">‚îÄ</button>
                    <button type="button" class="md-btn" data-action="checkbox" title="Checkbox">‚òë</button>
                </div>
                <textarea id="noteContent" class="form-textarea" rows="15" placeholder="Write your note here... Markdown is supported!"></textarea>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="notePinned">
                    <span>Pin this note</span>
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
            <button class="btn btn-primary" id="saveNoteBtn">Save Note</button>
        </div>
    </div>
</div>

<script>
    // View modal elements
    const viewModal = document.getElementById('noteViewModal');
    const closeViewModalBtn = document.getElementById('closeViewModal');
    const viewNoteTitle = document.getElementById('viewNoteTitle');
    const viewNoteCategory = document.getElementById('viewNoteCategory');
    const viewNoteContent = document.getElementById('viewNoteContent');
    const editNoteBtn = document.getElementById('editNoteBtn');
    const deleteNoteBtn = document.getElementById('deleteNoteBtn');

    // Editor modal and form elements
    const modal = document.getElementById('noteModal');
    const modalTitle = document.getElementById('modalTitle');
    const closeModalBtn = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveNoteBtn = document.getElementById('saveNoteBtn');
    const noteTitle = document.getElementById('noteTitle');
    const noteContent = document.getElementById('noteContent');
    const noteCategory = document.getElementById('noteCategory');
    const notePinned = document.getElementById('notePinned');

    let currentNoteId = null;
    let currentViewNoteId = null;

    // Markdown helper functions
    function insertMarkdown(action) {
        const textarea = noteContent;
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        const beforeText = textarea.value.substring(0, start);
        const afterText = textarea.value.substring(end);

        let insertion = '';
        let cursorOffset = 0;

        switch(action) {
            case 'header':
                insertion = selectedText ? '# ' + selectedText : '# ';
                cursorOffset = insertion.length;
                break;
            case 'bold':
                insertion = selectedText ? '**' + selectedText + '**' : '****';
                cursorOffset = selectedText ? insertion.length : 2;
                break;
            case 'italic':
                insertion = selectedText ? '*' + selectedText + '*' : '**';
                cursorOffset = selectedText ? insertion.length : 1;
                break;
            case 'strikethrough':
                insertion = selectedText ? '~~' + selectedText + '~~' : '~~~~';
                cursorOffset = selectedText ? insertion.length : 2;
                break;
            case 'code':
                insertion = selectedText ? '`' + selectedText + '`' : '``';
                cursorOffset = selectedText ? insertion.length : 1;
                break;
            case 'codeblock':
                insertion = '```\n\n```';
                cursorOffset = 4;
                break;
            case 'link':
                insertion = selectedText ? '[' + selectedText + '](url)' : '[](url)';
                cursorOffset = selectedText ? insertion.length - 4 : 1;
                break;
            case 'list':
                insertion = selectedText ? '- ' + selectedText : '- ';
                cursorOffset = insertion.length;
                break;
            case 'numberedlist':
                // Smart numbering: detect the number from the previous line
                const lines = beforeText.split('\n');
                const lastLine = lines[lines.length - 1];
                const numberMatch = lastLine.match(/^(\d+)\.\s/);
                const nextNumber = numberMatch ? parseInt(numberMatch[1]) + 1 : 1;
                insertion = selectedText ? `${nextNumber}. ` + selectedText : `${nextNumber}. `;
                cursorOffset = insertion.length;
                break;
            case 'quote':
                insertion = selectedText ? '> ' + selectedText : '> ';
                cursorOffset = insertion.length;
                break;
            case 'hr':
                insertion = '\n---\n';
                cursorOffset = insertion.length;
                break;
            case 'checkbox':
                insertion = selectedText ? '- [ ] ' + selectedText : '- [ ] ';
                cursorOffset = insertion.length;
                break;
        }

        textarea.value = beforeText + insertion + afterText;
        textarea.focus();
        textarea.setSelectionRange(start + cursorOffset, start + cursorOffset);
    }

    // Markdown toolbar buttons
    document.querySelectorAll('.md-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const action = btn.getAttribute('data-action');
            insertMarkdown(action);
        });
    });

    // View modal functions
    function openViewModal(noteId) {
        currentViewNoteId = noteId;
        console.log('Opening view modal for note ID:', noteId);

        fetch(`/notes/api/notes/${noteId}`)
            .then(response => response.json())
            .then(note => {
                console.log('Loaded note for viewing:', note);
                viewNoteTitle.textContent = note.title;

                // Show category if exists
                if (note.category) {
                    viewNoteCategory.innerHTML = `<span class="category">${escapeHtml(note.category)}</span>`;
                } else {
                    viewNoteCategory.innerHTML = '';
                }

                // Render markdown content
                viewNoteContent.innerHTML = marked.parse(note.content || '*No content*');

                // Make checkboxes interactive
                setupInteractiveCheckboxes(viewNoteContent, note);

                viewModal.classList.add('active');
            });
    }

    // Setup interactive checkboxes in rendered markdown
    function setupInteractiveCheckboxes(container, note) {
        const checkboxes = container.querySelectorAll('input[type="checkbox"]');

        checkboxes.forEach((checkbox, index) => {
            checkbox.style.cursor = 'pointer';

            checkbox.addEventListener('change', function() {
                // Update the markdown source
                const lines = note.content.split('\n');
                let checkboxCount = 0;

                for (let i = 0; i < lines.length; i++) {
                    // Match checkbox patterns: - [ ] or - [x]
                    const checkboxMatch = lines[i].match(/^(\s*)-\s+\[([ x])\]/);

                    if (checkboxMatch) {
                        if (checkboxCount === index) {
                            // Toggle this checkbox
                            const isChecked = this.checked;
                            lines[i] = lines[i].replace(/^(\s*)-\s+\[([ x])\]/, `$1- [${isChecked ? 'x' : ' '}]`);
                            break;
                        }
                        checkboxCount++;
                    }
                }

                // Update the note content
                note.content = lines.join('\n');

                // Save to backend
                fetch(`/notes/api/notes/${note.id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        title: note.title,
                        content: note.content,
                        category: note.category,
                        is_pinned: note.is_pinned
                    })
                })
                .then(() => {
                    // Optionally reload the notes list to show updated preview
                    loadNotes();
                })
                .catch(error => {
                    console.error('Error updating checkbox:', error);
                    // Revert checkbox state on error
                    this.checked = !this.checked;
                });
            });
        });
    }

    function closeViewModal() {
        viewModal.classList.remove('active');
        currentViewNoteId = null;
    }

    // Editor modal functions
    function openModal(noteId = null) {
        currentNoteId = noteId;

        if (noteId) {
            // Edit existing note
            modalTitle.textContent = 'Edit Note';

            // Clear form first
            noteTitle.value = '';
            noteContent.value = '';
            noteCategory.value = '';
            notePinned.checked = false;

            fetch(`/notes/api/notes/${noteId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch note');
                    }
                    return response.json();
                })
                .then(note => {
                    console.log('Loaded note for editing:', note);
                    noteTitle.value = note.title || '';
                    noteContent.value = note.content || '';
                    noteCategory.value = note.category || '';
                    notePinned.checked = note.is_pinned || false;

                    // Open modal after data is loaded
                    modal.classList.add('active');
                    noteTitle.focus();
                })
                .catch(error => {
                    console.error('Error loading note for editing:', error);
                    alert('Error loading note. Please try again.');
                });
        } else {
            // New note
            modalTitle.textContent = 'New Note';
            noteTitle.value = '';
            noteContent.value = '';
            noteCategory.value = '';
            notePinned.checked = false;

            // Open modal immediately for new notes
            modal.classList.add('active');
            noteTitle.focus();
        }
    }

    function closeModal() {
        modal.classList.remove('active');
        currentNoteId = null;
    }

    // Save note
    function saveNote() {
        const data = {
            title: noteTitle.value || 'Untitled',
            content: noteContent.value,
            category: noteCategory.value || null,
            is_pinned: notePinned.checked
        };

        const url = currentNoteId
            ? `/notes/api/notes/${currentNoteId}`
            : '/notes/api/notes';
        const method = currentNoteId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(() => {
            closeModal();
            loadNotes();
        })
        .catch(error => {
            console.error('Error saving note:', error);
            alert('Error saving note. Please try again.');
        });
    }

    // Delete note
    function deleteNote() {
        if (!currentViewNoteId) return;

        if (confirm('Are you sure you want to delete this note? This action cannot be undone.')) {
            fetch(`/notes/api/notes/${currentViewNoteId}`, {
                method: 'DELETE'
            })
            .then(() => {
                closeViewModal();
                loadNotes();
            })
            .catch(error => {
                console.error('Error deleting note:', error);
                alert('Error deleting note. Please try again.');
            });
        }
    }

    // Load notes
    function loadNotes() {
        const container = document.getElementById('notes-list');
        container.innerHTML = '<div class="loading empty-state"><p>Loading notes...</p></div>';

        fetch('/notes/api/notes')
            .then(response => response.json())
            .then(notes => {
                if (notes.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No notes yet. Click "New Note" to create one!</p></div>';
                    return;
                }
                container.innerHTML = notes.map(note => {
                    // Render markdown content for preview with formatting
                    let preview = '';
                    if (note.content) {
                        const rendered = marked.parse(note.content);
                        preview = rendered;
                    }

                    return `
                        <div class="note-card no-select" data-id="${note.id}" data-note='${JSON.stringify(note).replace(/'/g, "&#39;")}'>
                            ${note.is_pinned ? '<span class="pinned-badge">Pinned</span>' : ''}
                            <h3>${escapeHtml(note.title)}</h3>
                            <div class="note-content">${preview}</div>
                            <div class="note-meta">
                                ${note.category ? `<span class="category">${escapeHtml(note.category)}</span>` : ''}
                                <span class="date">${new Date(note.updated_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                // Add click handlers to note cards - open view modal
                document.querySelectorAll('.note-card').forEach(card => {
                    const noteId = card.getAttribute('data-id');
                    const noteData = JSON.parse(card.getAttribute('data-note'));
                    const contentDiv = card.querySelector('.note-content');

                    // Setup interactive checkboxes in preview
                    setupInteractiveCheckboxes(contentDiv, noteData);

                    // Open view modal when clicking card (but not checkboxes)
                    card.addEventListener('click', (e) => {
                        // Don't open modal if clicking a checkbox
                        if (e.target.type === 'checkbox') {
                            e.stopPropagation();
                            return;
                        }
                        openViewModal(noteId);
                    });
                });
            })
            .catch(error => {
                container.innerHTML = '<div class="empty-state"><p>Error loading notes. Please try again.</p></div>';
                console.error('Error loading notes:', error);
            });
    }

    // Utility function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Event listeners for view modal
    closeViewModalBtn.addEventListener('click', closeViewModal);
    editNoteBtn.addEventListener('click', () => {
        console.log('Edit button clicked, currentViewNoteId:', currentViewNoteId);
        if (currentViewNoteId) {
            // Save the note ID before closing the modal (which sets currentViewNoteId to null)
            const noteIdToEdit = currentViewNoteId;
            closeViewModal();
            openModal(noteIdToEdit);
        } else {
            console.error('No currentViewNoteId set!');
        }
    });
    deleteNoteBtn.addEventListener('click', deleteNote);

    // Event listeners for editor modal
    document.getElementById('new-note-btn').addEventListener('click', () => openModal());
    closeModalBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    saveNoteBtn.addEventListener('click', saveNote);

    // Close modals on outside click
    viewModal.addEventListener('click', (e) => {
        if (e.target === viewModal) {
            closeViewModal();
        }
    });

    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });

    // Close modals on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (viewModal.classList.contains('active')) {
                closeViewModal();
            } else if (modal.classList.contains('active')) {
                closeModal();
            }
        }
    });

    // Load notes on page load
    loadNotes();
</script>

<!-- Marked.js for markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
<script>
    // Configure marked
    marked.setOptions({
        breaks: true,
        gfm: true
    });
</script>
{% endblock %}
